#!/usr/bin/env jruby

require 'rubygems'
require 'bundler'
Bundler.setup(:default, :test)
require 'watchr'

# This Watchr monkeypatch does two things:
# 1) allows it to detect new files created that match its patterns
# 2) fix a bug where reloading the .watchr file itself caused an infinite loop.
module Watchr
  class EventHandler::Portable
    def refresh(monitored_paths)
      initialize                  # reset reference times
      update_monitored_paths(monitored_paths)
    end

    def update_monitored_paths(paths)
      @monitored_paths = paths
    end
  end
  class Controller
    def self.new(*)
      controller = super
      controller.watch_for_new_files
      controller
    end
    def watch_for_new_files
      @new_file_thread = Thread.new do
        loop do
          @handler.update_monitored_paths(monitored_paths)
          sleep(2)
        end
      end
    end
  end
end

ARGV.clear; ARGV.unshift "script/project.watchr"
load File.join(Gem.loaded_specs['watchr'].full_gem_path, 'bin', 'watchr')
